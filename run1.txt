/TEXT /local/Sys/PassWord/db/0

/set pw:super:super gold 90
/set pw:foo:bar gold 70
/set pw:*:xyzzy gold 30
/set pw:*:* gold 10

/TEXT /root/Sys/ServeSite/db/0

/set serve:localhost:8080 site local
/set serve:localhost:8081 site larp

/TEXT /local/Main/HomePage/wiki/0

This is the HomePage.

/TEXT /root/Mixin/MixinFirst/src/0

# -- I am the first Mixin

proc Puts {str} {
	/fmt/Fprintf $W %s $str
}

proc ModeHtml {} {
	send [send $W Header] Set "Content-Type" "text/html"
}

set WikiPage_rx [RxCompile {^([A-Z]+[a-z]+[A-Z][A-Za-z0-9_]*)$}]

proc Route { path query } {
	send $R ParseForm

	set Query [send [getf $R URL] Query]
	set Form [getf $R Form]

	set content [send $R FormValue text]
	set content2 [send [send [getf $R URL] Query] Get text]

	ModeHtml

	/fmt/Fprintf $W %v $Form
	/fmt/Fprintf $W %s " == Form <br>"

	/fmt/Fprintf $W %v $Query
	/fmt/Fprintf $W %s " == Query <br>"

	if {[catch {

		set rx [RxCompile {^/([A-Z][a-z]+)/([A-Z]+[a-z]+[A-Z][A-Za-z0-9_]*)([.]([a-z]+))?$}]
		set m [send $rx FindStringSubmatch $path]
		if {[notnull $m]} {
			set Volume [lat $m 1]
			set Page [lat $m 2]
			set Verb [lat $m 4]
			catch { Puts "Level: [level]<br>" } _
			catch { Puts "Host: [host]<br>" } _
			catch { Puts "Site: [site]<br>" } _
			catch { Puts "User: [user]<br>" } _
			catch { Puts "Vol: $Volume<br>" } _
			catch { Puts "Page: $Page<br>" } _
			catch { Puts "Verb: $Verb<br>" } _

			Verb/$Verb
		} else {
			Puts "Did not understand the path!"
		}

	} what]} {
		Puts "*** Caught an error: $what"
	}
}

proc Verb/view {} {
	set c [ReadFile [site] $Volume $Page wiki]

	Puts $c
}

proc Verb/list {} {
	Puts "<ul>"
	set pages [ListPages [site] $Volume]
	foreach p $pages {
		set m [send $WikiPage_rx FindStringSubmatch $p]
		if {[notnull $m]} {
			set page [lat $m 1]
			Puts "<li><a href=$page.view>$page</a></li>"
		}
	}
	Puts "</ul>"
}

proc Verb/edit {} {
	Puts "Method: [getf $R Method] <br>"
	if 0 {
		Puts "Content len: [slen $content] <br>"
		Puts "Content value: $content <br>"
		Puts "Content2 len: [slen $content2] <br>"
		Puts "Content2 value: $content2 <br>"

		#if {[set content]} {
		#	WriteFile [site] $Volume $Page wiki $content
		#}
	}

	set c [ReadFile [site] $Volume $Page wiki]

	Puts "<form method=POST action=/$Volume/$Page.edit>"
	Puts "<textarea name=text>$c</textarea>"
	Puts "<br>"
	Puts "<input type=submit value=Submit>"
	Puts "</form>"
}

proc Verb/db {} {
	/fmt/Fprintf $W %v [DB]
	/fmt/Fprintf $W %v [db-select-like [DB] * * * * * *]
}


/TEXT /larp/Main/HomePage/wiki/0

This is the larp HomePage.

/TEXT /larp/Characters/OlSmithy/data/0

/set player_name:*     {John Henry}
/set character_name:*  {Ol Smithy}
/set points:total      317
/set points:spent      315
/set points:unspent    2
/set home_world:*      {Empire of Perfect Unity}
/set prowess:*         4
/set mastery:*         0

# Should I do skills and traits like this?
/set traits:*          Tough 1 Learned 1 Perceptive 1 Strong 1
/set skill:levels      Craft 8 Scholarship 7 Mercantile 1 Sword 3
/set skill:specialties Craft {{Weaponcraft x3}} Scholarship {Swords {World Striders}}
/set skill:abilities   Craft {{Spark of Creation} {Signature Work: Longsword}} Scholarship {Epiphany}

# ...or like this?
/set tough:level       1
/set learned:level     1
/set perceptive:level  1
/set strong:level      1
/set craft:level       8
/set craft:specialties {Weaponcraft x3}
/set craft:abilities   {Spark of Creation} {Signature Work: Longsword}
/set scholarship:level       7
/set scholarship:specialties Swords {World Striders}
/set scholarship:abilities   Epiphany
/set sword:level       3

# Here's how I imagine the data for this character would be represented in JSON

{
  "player_name": "John Henry",
  "character_name": "Ol Smithy",
  "points": {
    "total": 317,
    "spent": 315,
    "unspent": 2
  },
  "home_world": "Empire of Perfect Unity",
  "traits": [
    { "name": "Tough", "level": 1 },
    { "name": "Learned", "level": 1 },
    { "name": "Perceptive", "level": 1 },
    { "name": "Strong", "level": 1 }
  ],
  "skills": [
    {
      "name": "Craft",
      "level": 8,
      "specialties": ["Weaponcraft x3"],
      "abilities": ["Spark of Creation", "Signature Work: Longsword"]
    },
    {
      "name": "Scholarship",
      "level": 7,
      "specialties": ["Swords", "World Striders"],
      "abilities": "Epiphany"
    },
    {
      "name": "Sword",
      "level": 3
    }
  ]
}

/TEXT /larp/Characters/Marina/data/0

/set player_name:*     {Janet Snufflepuff}
/set character_name:*  {Marina}
/set points:total      255
/set points:spent      230
/set points:unspent    25
/set home_world:*      {Enchanted Glade}
/set prowess:*         0
/set mastery:*         11

# Traits
/set willful:level     1
/set attuned:level     2
/set empathic:level    1

# Skills
/set occult:level      3
/set healing:level     1
/set performance:level 1

# Magic Schools
/set woodsong_and_moonsecret:level     8
/set woodsong_and_moonsecret:abilities {Empowered Spell} {Greater Working}
/set woodsong_and_moonsecret:greater_workings {Marina Steals the Weight of Years}
/set woodsong_and_moonsecret:spells    {Ring of the Fair Ones} {Glasswing's Gentle Mien} {Secrets Under Toadstools} {Call the Clutching Weeds} {Stillthorn Curse} {Joy Takes Flight}
/set woodsong_and_moonsecret:rituals   {Feet of the Greenwise} {Sleep of the Ageless} {Name the Little One} {Likeness in Clay} {Cleansing Sunlit Waters} {Ply the Stones}
# Will this work?
/set Glasswing's Gentle Mien:empowered 1

/set currents_of_deepspirit:level     3
/set currents_of_deepspirit:spells    {Bearing Unseen Gifts} {Balance, in All Things} {Know The Spirit Ways}
/set currents_of_deepspirit:abilities {The City is Life} {Drawing the Third Eye} {The Sound that Pleases}


# Here's how I imagine the data for this character would be represented in JSON

{

  "player_name": "Janet Snufflepuff",
  "character_name": "Marina",
  "points": {
    "total": 255,
    "spent": 230,
    "unspent": 25
  },
  "home_world": "Enchanted Glade",
  "traits": [
    { "name": "Willful", "level": 1 },
    { "name": "Attuned", "level": 2 },
    { "name": "Empathic", "level": 1 }
  ],
  "skills": [
    { "name": "Occult", "level": 3 },
    { "name": "Healing", "level": 1 },
    { "name": "Performance", "level": 1 }
  ],
  "magic_schools": [
    {
      "name": "Woodsong and Moonsecret",
      "level": 8,
      "abilities": [ "Empowered Spell", "Greater Working" ],
      "greater_workings": [ "Marina Steals the Weight of Years" ],
      "spells": [
        { "name": "Ring of the Fair Ones" },
        { "name": "Glasswing's Gentle Mien", "empowered": true },
        { "name": "Secrets Under Toadstools" },
        { "name": "Call the Clutching Weeds" },
        { "name": "Stillthorn Curse" },
        { "name": "Joy Takes Flight" }
      ],
      "rituals": [
        { "name": "Feet of the Greenwise" },
        { "name": "Sleep of the Ageless" },
        { "name": "Name the Little One" },
        { "name": "Likeness in Clay" },
        { "name": "Cleansing Sunlit Waters" },
        { "name": "Ply the Stones" }
      ]
    },
    {
      "name": "Currents of Deepspirit",
      "level": 3,
      "spells": [
        { "name": "Bearing Unseen Gifts" },
        { "name": "Balance, in All Things" },
        { "name": "Know the Spirit Ways" }
      ],
      "rituals": [
        { "name": "The City is Life" },
        { "name": "Drawing the Third Eye" },
        { "name": "The Sound that Pleases" }
      ]
    }
  ]
}
