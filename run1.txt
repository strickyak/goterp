/TEXT /local/Sys/PassWord/db/0

/set pw:super:super gold 90
/set pw:foo:bar gold 70
/set pw:*:xyzzy gold 30
/set pw:*:* gold 10

/TEXT /root/Sys/ServeSite/db/0

/set serve:localhost:8080 site local
/set serve:localhost:8081 site larp

/TEXT /local/Main/HomePage/wiki/0

This is the HomePage.

/TEXT /root/Mixin/MixinFirst/src/0

proc HtmlOutput {} { tag html [ht [HtmlHead] [HtmlBody] [WikiTail]] }
proc HtmlHead {} { tag head [ht [HtmlTitle] [HtmlCss]] }
proc HtmlTitle {} { tag title [ht $Volume -- $Page -- $Verb] }
proc HtmlCss {} { ht }
proc HtmlBody {} { tag body [ht [WikiTop] [WikiMiddle] [WikiBottom]] }

proc WikiTop {} { tag div class WikiTop [WideTable [list [list "TOP"]]] }
proc WikiMiddle {} { tag div class WikiMiddle [WikiText] }
proc WikiBottom {} { tag div class WikiBottom [WideTable [list [list "BOTTOM"]]] }
proc WikiTail {} { tag div class WikiTail [WikiNotes] }

proc WikiText {} { ReadFile [site] $Volume $Page wiki }

proc WideTable rows {
	set rr {}
	foreach r $rows {
		set dd {}
		foreach d $r {
			lappend dd [tag td align left $d]
		}
		lappend rr [tag tr [eval ht $dd]]
	}
	tag table width 99% border 1 cellpadding 5 [eval ht $rr]
}
set Notes {}
proc Note x {
	lappend Notes $x
}
proc WikiNotes {} {
	set nn {}
	foreach n $Notes {
		lappend nn [tag li class WikiNote $n]
	}
	tag ul class WikiNotes [eval ht $nn]
}
			
proc ShowValue v {
	/fmt/Sprintf %v $v
}

proc Puts {str} {
	/fmt/Fprintf $W %s $str
}

proc ModeHtml {} {
	send [send $W Header] Set "Content-Type" "text/html"
}

set WikiPage_rx [RxCompile {^([A-Z]+[a-z]+[A-Z][A-Za-z0-9_]*)$}]

proc Route { path query } {
	send $R ParseForm

	set Query [send [getf $R URL] Query]
	set Form [getf $R Form]

	set content [send $R FormValue text]
	set content2 [send [send [getf $R URL] Query] Get text]

	ModeHtml

	if {$path eq "/"} {
		set path "/Main/HomePage.view"
	}

	if {[catch {

		set rx [RxCompile {^/([A-Z][a-z]+)/([A-Z]+[a-z]+[A-Z][A-Za-z0-9_]*)([.]([a-z]+))?$}]
		set m [send $rx FindStringSubmatch $path]
		if {[notnull $m]} {
			set _,Volume,Page,_,Verb $m
			catch { Note "Query: [ShowValue $Query]" } _
			catch { Note "Form: [ShowValue $Form]" } _
			catch { Note "Level: [level]" } _
			catch { Note "Host: [host]" } _
			catch { Note "Site: [site]" } _
			catch { Note "User: [user]" } _
			catch { Note "Vol: $Volume" } _
			catch { Note "Page: $Page" } _
			catch { Note "Verb: $Verb" } _
			Note [tag a href /Main/HomePage.list LIST]
			Note [tag a href /Main/HomePage.view HomePage]

			Verb/$Verb
		} else {
			Puts "Did not understand the path!"
		}

	} what]} {
		Puts "*** Caught an error: $what"
	}
}

proc Verb/view {} {
	Puts [HtmlOutput]
}

proc DoVerbList {} {
	set zz {}
	foreach p [ListPages [site] $Volume] {
		set m [send $WikiPage_rx FindStringSubmatch $p]
		if {[notnull $m]} {
			set _,page $m
			lappend zz [tag li [tag a href $page.view $page]]
		}
	}
	tag ul [eval ht $zz]
}

proc Verb/list {} {
	proc WikiMiddle {} {
		DoVerbList
	}

	Puts [HtmlOutput]
}

proc Verb/edit {} {
	Puts "Method: [getf $R Method] <br>"
	if 0 {
		Puts "Content len: [slen $content] <br>"
		Puts "Content value: $content <br>"
		Puts "Content2 len: [slen $content2] <br>"
		Puts "Content2 value: $content2 <br>"

		#if {[set content]} {
		#	WriteFile [site] $Volume $Page wiki $content
		#}
	}

	set c [ReadFile [site] $Volume $Page wiki]

	Puts "<form method=POST action=/$Volume/$Page.edit>"
	Puts "<textarea name=text>$c</textarea>"
	Puts "<br>"
	Puts "<input type=submit value=Submit>"
	Puts "</form>"
}

proc Verb/db {} {
	/fmt/Fprintf $W %v [DB]
	/fmt/Fprintf $W %v [db-select-like [DB] * * * * * *]
}


/TEXT /larp/Main/HomePage/wiki/0

This is the larp HomePage.

/TEXT /larp/Characters/TableCharacters_OlSmithy/db/0

/set player_name:    {John Henry}
/set character_name: {Ol Smithy}
/set points:total    317
/set points:spent    315
/set points:unspent  2
/set home_world:     {Empire of Perfect Unity}
/set prowess:        4
/set mastery:        0

# Traits
/set trait_level:tough      1
/set trait_level:learned    1
/set trait_level:perceptive 1
/set trait_level:strong     1

# Skill: Craft
/set skill_level:craft       8
/set skill_specialties:craft {Weaponcraft x3}
/set skill_abilities:craft   {Spark of Creation} {Signature Work: Longsword}

# Skill: Scholarship
/set skill_level:scholarship       7
/set skill_specialties:scholarship Swords {World Striders}
/set skill_abilities:scholarship   Epiphany

# Skill: Sword
/set skill_level:sword 3

# Here's how I imagine the data for this character would be represented in JSON

{
  "player_name": "John Henry",
  "character_name": "Ol Smithy",
  "points": {
    "total": 317,
    "spent": 315,
    "unspent": 2
  },
  "home_world": "Empire of Perfect Unity",
  "traits": [
    { "name": "Tough", "level": 1 },
    { "name": "Learned", "level": 1 },
    { "name": "Perceptive", "level": 1 },
    { "name": "Strong", "level": 1 }
  ],
  "skills": [
    {
      "name": "Craft",
      "level": 8,
      "specialties": ["Weaponcraft x3"],
      "abilities": ["Spark of Creation", "Signature Work: Longsword"]
    },
    {
      "name": "Scholarship",
      "level": 7,
      "specialties": ["Swords", "World Striders"],
      "abilities": "Epiphany"
    },
    {
      "name": "Sword",
      "level": 3
    }
  ]
}

/TEXT /larp/Characters/TableCharacters_Marina/db/0

/set player_name:    {Janet Snufflepuff}
/set character_name: {Marina}
/set points:total    255
/set points:spent    230
/set points:unspent  25
/set home_world:     {Enchanted Glade}
/set prowess:        0
/set mastery:        11

# Traits
/set trait_level:willful  1
/set trait_level:attuned  2
/set trait_level:empathic 1

# Skills
/set skill_level:occult      3
/set skill_level:healing     1
/set skill_level:performance 1

# Magic School: Woodsong and Moonsecret
/set school_level:woodsong_and_moonsecret            8
/set school_abilities:woodsong_and_moonsecret        {Empowered Spell} {Greater Working}
/set school_greater_workings:woodsong_and_moonsecret {Marina Steals the Weight of Years}
/set school_spells:woodsong_and_moonsecret           {Ring of the Fair Ones} {Glasswing's Gentle Mien} {Secrets Under Toadstools} {Call the Clutching Weeds} {Stillthorn Curse} {Joy Takes Flight}
/set school_empowered_spells:woodsong_and_moonsecret {Glasswing's Gentle Mien}
/set school_rituals:woodsong_and_moonsecret          {Feet of the Greenwise} {Sleep of the Ageless} {Name the Little One} {Likeness in Clay} {Cleansing Sunlit Waters} {Ply the Stones}

# Magic School: Currents of Deepspirit
/set school_level:currents_of_deepspirit   3
/set school_spells:currents_of_deepspirit  {Bearing Unseen Gifts} {Balance, in All Things} {Know The Spirit Ways}
/set school_rituals:currents_of_deepspirit {The City is Life} {Drawing the Third Eye} {The Sound that Pleases}

# Here's how I imagine the data for this character would be represented in JSON

{

  "player_name": "Janet Snufflepuff",
  "character_name": "Marina",
  "points": {
    "total": 255,
    "spent": 230,
    "unspent": 25
  },
  "home_world": "Enchanted Glade",
  "traits": [
    { "name": "Willful", "level": 1 },
    { "name": "Attuned", "level": 2 },
    { "name": "Empathic", "level": 1 }
  ],
  "skills": [
    { "name": "Occult", "level": 3 },
    { "name": "Healing", "level": 1 },
    { "name": "Performance", "level": 1 }
  ],
  "magic_schools": [
    {
      "name": "Woodsong and Moonsecret",
      "level": 8,
      "abilities": [ "Empowered Spell", "Greater Working" ],
      "greater_workings": [ "Marina Steals the Weight of Years" ],
      "spells": [
        { "name": "Ring of the Fair Ones" },
        { "name": "Glasswing's Gentle Mien", "empowered": true },
        { "name": "Secrets Under Toadstools" },
        { "name": "Call the Clutching Weeds" },
        { "name": "Stillthorn Curse" },
        { "name": "Joy Takes Flight" }
      ],
      "rituals": [
        { "name": "Feet of the Greenwise" },
        { "name": "Sleep of the Ageless" },
        { "name": "Name the Little One" },
        { "name": "Likeness in Clay" },
        { "name": "Cleansing Sunlit Waters" },
        { "name": "Ply the Stones" }
      ]
    },
    {
      "name": "Currents of Deepspirit",
      "level": 3,
      "spells": [
        { "name": "Bearing Unseen Gifts" },
        { "name": "Balance, in All Things" },
        { "name": "Know the Spirit Ways" }
      ],
      "rituals": [
        { "name": "The City is Life" },
        { "name": "Drawing the Third Eye" },
        { "name": "The Sound that Pleases" }
      ]
    }
  ]
}
